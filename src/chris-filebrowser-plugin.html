<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="./components/chris-parameter.html">


<dom-module id="chris-filebrowser-plugin">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>

    <div class="card">
      <div class="circle">3</div>
      <h1>Create feed from data</h1>

      <button on-click="_startPlugin">Start plugin</button>
      <dom-repeat items="[[plugins]]">
        <template>
          <div># [[item.data.name]] : [[item.parameters.length]] parameters</div>
          <div>
            <dom-repeat items="[[item.parameters]]">
              <template>
                <chris-parameter
                  name="{{item.data.name}}"
                  type="{{item.data.type}}"
                  help="{{item.data.help}}"
                  default="{{item.data.default}}"
                  on-value-changed="_valueChanged"
                  ></chris-parameter>
              </template>
              </dom-repeat>
          </div>
       </template>
      </dom-repeat>

      <button on-click="_fetchData">Fetch data</button>

      <dom-repeat items="[[data]]">
        <template>
          <div># [[item.data.upload_path]]</div>
       </template>
      </dom-repeat>

    </div>
  </template>

  <script>
    class ChrisFilerowserPlugin extends Polymer.Element {
      static get is() { return 'chris-filebrowser-plugin'; }

      static get properties() {
        return {
          ip: String,
          port: String,
          namespace: String,
          data: Array,
          plugins: Array,
        };
      }

      _fetchData() {
        this.dispatchEvent(
          new CustomEvent('fetch-data', {detail: {}}));
      }

      _findPlugin(targetPluginName, currentPlugin) {
        return currentPlugin.data.name === targetPluginName;
      }

      _startPlugin() {
        // start plugin sequence
        const data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('auth-token'),
        };

        // add templates
        data.body = {};
        data.body.template = {};
        data.body.template.data = [
          {name: 'dir', value: ''},
        ];

        data.body.data = {};
        data.body.data['dir'] = './';

        const simpleFSApp =
          this.plugins.filter(this._findPlugin.bind(this, 'simplefsapp'))[0];
        const instance = simpleFSApp.links.instances;

        this.dispatchEvent(
          new CustomEvent('run-plugin', {
            detail: {
              instance,
              data,
              type: 'fs',
            },
          }));
      }
    }

    window.customElements.define(ChrisFilerowserPlugin.is, ChrisFilerowserPlugin);
  </script>
</dom-module>
