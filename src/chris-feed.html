<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">


<link rel="import" href="shared-styles.html">
<link rel="import" href="./components/chris-plugin-starter.html">

<dom-module id="chris-feed">
  <template>
    <style include="shared-styles">
      :host {
        display: flex;
        flex-direction: column;
      }

      .loadingIndicator {
        text-align: center;
        height: 40px;
        color: #fff;
      }

      .wrapper {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      chris-plugin-starter {
        margin-top: 16px;
      }

      paper-card {
        width: 100%;
        margin: auto;
        margin-top: 20px;
        margin-bottom: 10px;
        margin-left: 16px;
        margin-right: 16px;
      }

      @media (min-width: 860px) {
        paper-card {
          max-width: 800px;
        }
      }

      [hidden] {
        display: none;
      }
    </style>

    <div hidden$="[[!waitingForNewPlugin]]" class="loadingIndicator">
      <paper-spinner active></paper-spinner> Starting plugin....
    </div>

    <chris-plugin-starter
      hidden$="[[!lastPluginFinishedSuccessfully]]"
      feed="[[feed]]"
      plugins="[[plugins]]"
      on-run-plugin="_runPluginSent"
      ></chris-plugin-starter>

    <div class="wrapper">
      <dom-repeat id="test" items="[[feed]]" mutable-data>
        <template>
          <paper-card heading="[[item.data.plugin_name]]" alt="[[item.data.plugin_name]]">
            <div class="card-content">
              ID: [[item.data.id]] by ID: [[item.data.owner]] status: [[item.data.status]]
              <dom-repeat items="[[feedData]]" as="yo" filter="[[_isPluginSelected(item)]]" mutable-data>
                  <template>
                    <div>
                [[yo.name]]
                </div>
                </template>
              </dom-repeat>
            </div>
            <div class="card-actions">
              <paper-button>Share</paper-button>
              <paper-button>Explore!</paper-button>
              data: [[feedData.length]]
            </div>
          </paper-card>
        </template>
      </dom-repeat>
    </div>
  </template>

  <script>
    class ChrisFeed extends Polymer.Element {
      static get is() { return 'chris-feed'; }

      static get properties() {
        return {
          feed: {
            type: Array,
            observer: '_feedChanged',
          },
          feedData: {
            type: Array,
            observer: '_feedDataChanged',
          },
          plugins: Array,
          waitingForNewPlugin: Boolean,
          lastPluginFinishedSuccessfully: Boolean,
        };
      }

      static get observers() {
        return [
          // Observer method name, followed by a list of dependencies, in parenthesis
          '_feedDeepChanged(feed.*)',
          '_feedDataChanged(feedData.splices)',
        ];
      }

      _feedChanged(current, previous) {
        console.log(current);
        console.log(previous);

        if (current === undefined) return;

        if (current.length === 0) {
          this.lastPluginFinishedSuccessfully = true;
        } else {
          this.lastPluginFinishedSuccessfully =
            current[0].data.status === 'finishedSuccessfully';
          if (previous === undefined || current.length > previous.length) {
            this.waitingForNewPlugin = false;
          }
        }
      }

      _feedDeepChanged(feed) {
        if (feed.path.endsWith('.status')) {
          console.log(feed);
          this.lastPluginFinishedSuccessfully =
            (feed.value === 'finishedSuccessfully');
        }
      }

      _feedDataChanged(feedData) {
        console.log(feedData);
        this.$.test.render();
      }

      _runPluginSent() {
        this.lastPluginFinishedSuccessfully = false;
        this.waitingForNewPlugin = true;
      }

      _isPluginSelected(pluginInstance, data) {
        // if (data.from instance is plugin instance, show it)
        return false;
      }
    }

    window.customElements.define(ChrisFeed.is, ChrisFeed);
  </script>
</dom-module>
