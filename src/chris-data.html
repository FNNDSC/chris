<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../bower_components/chips-api/chips-api.html">

<!-- restart from scatch, something is wrong with it -->
<dom-module id="chris-data">
  <template>
    <chips-api
      id="API"
      api="ultron"
      api-root="[[ip]]:[[port]]/[[namespace]]">
    </chips-api>

    <!-- https://github.com/PolymerElements/iron-list/blob/master/demo/scroll-threshold.html -->
    <!-- https://www.webcomponents.org/element/PolymerElements/iron-scroll-threshold -->
    <iron-ajax id="ajax"
      url="https://randomuser.me/api/"
      params='{"results": 20}'
      handle-as="json"
      loading="{{loadingPeople}}"
      on-response="_didRespond"></iron-ajax>
  </template>

  <script>
    class ChrisData extends Polymer.Element {
      static get is() { return 'chris-data'; }
      static get properties() {
        return {
          ip: String,
          port: String,
          namespace: String,
          feeds: {
            type: Array,
            value: () => [],
            notify: true,
          },
        };
      }

      fetchFeeds(from, to, filter) {
        const pageSize = to - from;

        // through the API
        var data = {};
        data.auth = {
          type: 'token',
          token: sessionStorage.getItem('auth-token'),
        };
        data.params = {};
        data.params.offset = from;
        data.params.limit = pageSize;
        data.params.page_size = pageSize;
        // const feedQuery = this.$.API.request('GET', 'feeds', data);
        // feedQuery
        //   .then(this._handleFeedsResponse.bind(this))
        //   .catch(this._handleFeedsError.bind(this));
        console.log('fetch feeds');
        const request = this.$.ajax.generateRequest();
        request.completes
          .then(this._handleFeedsResponse.bind(this))
          .catch(this._handleFeedsError.bind(this));
      }

      _handleFeedsResponse(request) {
        console.log(request.response);
        const results = request.response.results;
        console.log(this.feeds);
        const feeds = [...this.feeds];
        for (let i=0; i<results.length; i++) {
          const result = results[i];
          feeds.push(result);
        }

        this.set('feeds', feeds);
        console.log(this.feeds);
      }

      _handleFeedsError(request) {
        console.log(request.error);
      }
    }

    window.customElements.define(ChrisData.is, ChrisData);
  </script>
</dom-module>
